{% extends 'base.html' %}

{% block main_class %}profile-page container{% endblock %}

{% block content %}

<!-- Full-width Profile Hero (edge-to-edge like homepage hero) -->
<section class="profile-hero" data-banner-user-id="{{ profile_user.id }}" {% if profile_banner_url %}style="background-image: url('{{ profile_banner_url }}');"{% endif %}>
    <div class="profile-hero-overlay"></div>
    <div class="profile-hero-inner">
        <div class="profile-hero-left">
            <div class="profile-avatar {% if is_own_profile %}editable{% endif %}" {% if is_own_profile %}role="button"
                tabindex="0" aria-label="Change avatar" {% endif %}>
                {% if profile_user.pfp %}
                <img id="profileAvatarImg" src="data:image/jpeg;base64,{{ profile_user.pfp }}"
                    alt="{{ profile_user.username }}">
                {% else %}
                <img id="profileAvatarImg" src="/static/images/pfp-basic.jpg" alt="{{ profile_user.username }}">
                {% endif %}
                {% if is_own_profile %}
                <div class="avatar-hover-indicator" aria-hidden="true">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h3l2-3h8l2 3h3a2 2 0 0 1 2 2z">
                        </path>
                        <circle cx="12" cy="13" r="4"></circle>
                    </svg>
                </div>
                {% endif %}
            </div>
            <div class="profile-details">
                <h1 class="profile-username">{{ profile_user.username }}</h1>
                <p class="profile-fullname{% if profile_settings.hide_fullname == '1' %} is-hidden{% endif %}">{{ profile_user.firstname }} {{ profile_user.lastname }}</p>
                {% if is_own_profile %}
                <button class="btn btn-edit-profile" type="button">Edit Profile</button>
                {% else %}
                <button class="btn btn-follow" data-username="{{ profile_user.username }}" data-followed="{% if followed_by_me %}1{% else %}0{% endif %}">{% if followed_by_me %}Unfollow{% else %}Follow{% endif %}</button>
                {% endif %}
            </div>
        </div>
        <div class="profile-hero-right">
            <div class="profile-stats{% if profile_settings.hide_follow_stats == '1' %} is-hidden{% endif %}">
                <div class="stat">
                    <div class="stat-number">{{ profile_stats.lists|default:0 }}</div>
                    <div class="stat-label">Lists</div>
                </div>
                <div class="divider" aria-hidden="true"></div>
                <div class="stat">
                    <div class="stat-number">{{ profile_stats.watched|default:0 }}</div>
                    <div class="stat-label">Watched</div>
                </div>
                <div class="divider" aria-hidden="true"></div>
                <div class="stat">
                    <div class="stat-number" id="followingCount">{{ profile_stats.following|default:0 }}</div>
                    <div class="stat-label">Following</div>
                </div>
                <div class="divider" aria-hidden="true"></div>
                <div class="stat">
                    <div class="stat-number" id="followersCount">{{ profile_stats.followers|default:0 }}</div>
                    <div class="stat-label">Followers</div>
                </div>
            </div>
        </div>
    </div>
</section>

<div class="profile-container" data-is-own-profile="{% if is_own_profile %}1{% else %}0{% endif %}">

    <div class="profile-content">
        <div class="profile-tabs">
            <button class="tab-btn active" data-tab="profile">Profile</button>
            <button class="tab-btn" data-tab="lists">Lists</button>
            <button class="tab-btn" data-tab="reviews">Reviews</button>
        </div>

        <!-- Profile Tab -->
        <div class="tab-content active" id="profile-tab">
            <!-- Favorites -->
            <div class="section-block">
                <div class="section-header">
                    <h3>Favorites</h3>
                </div>
                {% if top_five %}
                <div class="favorites-row">
                    {% for it in top_five %}
                    <a class="fav-card" href="{{ it.go_url }}" title="{{ it.title }}">
                        <div class="fav-poster">
                            {% if it.poster_url %}
                            <img loading="lazy" src="{{ it.poster_url }}" alt="{{ it.title }}">
                            {% else %}
                            <div class="fav-placeholder">No Image</div>
                            {% endif %}
                            {% if it.score %}<span class="fav-score">{{ it.score|floatformat:1 }}</span>{% endif %}
                        </div>
                        <div class="fav-title">{{ it.title }}</div>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <p class="muted">No favorites yet.</p>
                {% endif %}
            </div>

            <!-- Recent Activity -->
            <div class="section-block">
                <div class="section-header">
                    <h3>Recent Activity</h3>
                </div>
                {% if recent_activity %}
                <div class="activity-list">
                    {% for ev in recent_activity %}
                    <a class="activity-item" href="{{ ev.go_url }}">
                        <div class="recent-poster">
                            {% if ev.poster_url %}
                            <img loading="lazy" src="{{ ev.poster_url }}" alt="{{ ev.title }}">
                            {% else %}
                            <div class="poster-placeholder">No Image</div>
                            {% endif %}
                        </div>
                        <div class="recent-meta">
                            <div class="recent-title">{{ ev.title }}</div>
                            <div class="recent-sub">
                                <span
                                    class="recent-chip {% if ev.action == 'watched' %}watched{% else %}listed{% endif %}">
                                    {% if ev.action == 'watched' %}Watched{% else %}Added to List{% endif %}
                                </span>
                                <span class="meta-dot">‚Ä¢</span>
                                <span class="recent-date">{{ ev.timestamp|date:"M j, Y" }}</span>
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <p class="muted">No recent activity.</p>
                {% endif %}
            </div>

            <!-- Recent Reviews -->
            <div class="section-block">
                <div class="section-header">
                    <h3>Recent Reviews</h3>
                </div>
                {% if recent_reviews %}
                <div class="reviews-list">
                    {% for r in recent_reviews %}
                    <a class="review-item" href="{{ r.go_url }}">
                        <div class="ri-poster">
                            {% if r.poster_url %}
                            <img loading="lazy" src="{{ r.poster_url }}" alt="{{ r.title }}">
                            {% else %}
                            <div class="ri-placeholder">No Image</div>
                            {% endif %}
                        </div>
                        <div class="ri-body">
                            <div class="ri-title">{{ r.title }}</div>
                            <div class="ri-sub">
                                {% if r.score %}<span class="ri-score">Score {{ r.score|floatformat:1 }}</span>{% endif %}
                                <span class="meta-dot">‚Ä¢</span>
                                <span class="ri-date">{{ r.updated_at|date:"M j, Y" }}</span>
                            </div>
                            {% if r.review_text %}<div class="ri-text">{{ r.review_text }}</div>{% endif %}
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <p class="muted">No reviews yet.</p>
                {% endif %}
            </div>
        </div>

        <!-- Lists Tab -->
        <div class="tab-content" id="lists-tab">
            {% if all_lists %}
            <div class="popular-lists-grid">
                {% for pl in all_lists %}
                <a class="popular-list-card" href="/list/{{ profile_user.username }}/{{ pl.name|slugify }}/">
                    <div class="pl-collage">
                        {% for it in pl.recent_items %}
                        <div class="pl-tile" style="background-image:url('{{ it.poster_url }}')"></div>
                        {% empty %}
                        <div class="pl-empty">No items yet</div>
                        {% endfor %}
                    </div>
                    <div class="pl-meta">
                        <div class="pl-title" title="{{ pl.name }}">{{ pl.name }}</div>
                        <div class="pl-user">
                            <span class="pl-username">@{{ profile_user.username }}</span>
                        </div>
                        <div class="pl-stats">
                            <span class="stat" title="Likes"><svg width="14" height="14" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="2.2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path
                                        d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z">
                                    </path>
                                </svg> {{ pl.likes_count|default:'0' }}</span>
                            <span class="stat" title="Comments"><svg width="14" height="14" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                </svg> {{ pl.comments_count|default:'0' }}</span>
                            <span class="stat">üé¨ {{ pl.item_counts.movies|default:'0' }}</span>
                            <span class="stat">üì∫ {{ pl.item_counts.shows|default:'0' }}</span>
                        </div>
                    </div>
                </a>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <i class="icon">üìã</i>
                <h3>No lists yet</h3>
                <p>{% if is_own_profile %}Create your first list to organize your favorites!{% else %}{{
                    profile_user.username }} hasn't created any lists yet.{% endif %}</p>
            </div>
            {% endif %}
        </div>

        <!-- Reviews Tab -->
        <div class="tab-content" id="reviews-tab">
            {% if all_reviews %}
            <div class="reviews-list all">
                {% for r in all_reviews %}
                <a class="review-item" href="{{ r.go_url }}">
                    <div class="ri-poster">
                        {% if r.poster_url %}
                        <img loading="lazy" src="{{ r.poster_url }}" alt="{{ r.title }}">
                        {% else %}
                        <div class="ri-placeholder">No Image</div>
                        {% endif %}
                    </div>
                    <div class="ri-body">
                        <div class="ri-title">{{ r.title }}</div>
                        <div class="ri-sub">
                            {% if r.score %}<span class="ri-score">Score {{ r.score|floatformat:1 }}</span>{% endif %}
                            <span class="meta-dot">‚Ä¢</span>
                            <span class="ri-date">{{ r.updated_at|date:"M j, Y" }}</span>
                        </div>
                        {% if r.review_text %}<div class="ri-text">{{ r.review_text }}</div>{% endif %}
                    </div>
                </a>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <i class="icon">üìù</i>
                <h3>No reviews yet</h3>
                <p>{% if is_own_profile %}Start reviewing your favorite shows and movies!{% else %}{{
                    profile_user.username }} hasn't written any reviews yet.{% endif %}</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    // CSRF helper (available globally in this page)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const isOwnProfile = (document.querySelector('.profile-container')?.dataset.isOwnProfile === '1');

    // Lazy-load banner backdrop
    (function loadProfileBanner() {
        const hero = document.querySelector('.profile-hero[data-banner-user-id]');
        if (!hero) return;
        const uid = hero.getAttribute('data-banner-user-id');
        // If server already set style, skip
        if (hero.style && hero.style.backgroundImage) {
            return;
        }
        fetch(`/profile/banner/${uid}/`).then(r => r.json()).then(data => {
            if (data && data.success && data.backdrop_url) {
                hero.style.backgroundImage = `url('${data.backdrop_url}')`;
            }
        }).catch(() => { });
    })();

    // Tab switching functionality
    document.querySelectorAll('.tab-btn').forEach(button => {
        button.addEventListener('click', () => {
            // Remove active class from all tabs and content
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Add active class to clicked tab
            button.classList.add('active');

            // Show corresponding content
            const tabName = button.getAttribute('data-tab');
            document.getElementById(tabName + '-tab').classList.add('active');
        });
    });

    // Follow/Unfollow
    (function initFollowButton() {
        const btn = document.querySelector('.btn-follow');
        if (!btn) return;
        // Ensure initial label from data-followed in case server markup is empty/malformed
        const initFollowed = btn.getAttribute('data-followed');
        if (!btn.textContent || /\{\%|\%\}/.test(btn.textContent)) {
            btn.textContent = initFollowed === '1' ? 'Unfollow' : 'Follow';
        }
        btn.addEventListener('click', async () => {
            const username = btn.getAttribute('data-username');
            btn.disabled = true;
            try {
                const res = await fetch('/profile/toggle-follow/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                    body: JSON.stringify({ username })
                });
                if (res.status === 401) { alert('Please log in to follow'); return; }
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'Failed');
                // Update button label/state
                btn.textContent = data.followed ? 'Unfollow' : 'Follow';
                btn.setAttribute('data-followed', data.followed ? '1' : '0');
                // Update followers count in stats
                const followersEl = document.getElementById('followersCount');
                if (followersEl && typeof data.followers === 'number') {
                    followersEl.textContent = data.followers;
                }
            } catch (e) {
                alert(e.message || 'Failed to update follow state');
            } finally {
                btn.disabled = false;
            }
        });
    })();

    // Avatar upload + crop (no external libs; simple pan/zoom)
    if (isOwnProfile) {
        // Edit Profile modal
        (function initEditProfile() {
            const btn = document.querySelector('.btn-edit-profile');
            if (!btn) return;
            btn.addEventListener('click', () => {
                const overlay = document.createElement('div');
                overlay.className = 'editprof-modal-overlay';
                overlay.innerHTML = `
                                    <div class="editprof-modal">
                                        <div class="editprof-header">
                                            <h3>Edit Profile</h3>
                                            <button class="editprof-close" aria-label="Close">√ó</button>
                                        </div>
                                                            <div class="editprof-body">
                                                                <div class="switch-row">
                                                                    <label class="switch">
                                                                        <input type="checkbox" id="hideFullnameToggle">
                                                                        <span class="slider"></span>
                                                                    </label>
                                                                    <span class="switch-label">Hide first & last name on my profile</span>
                                                                </div>
                                                                <div class="switch-row">
                                                                    <label class="switch">
                                                                        <input type="checkbox" id="hideFollowStatsToggle">
                                                                        <span class="slider"></span>
                                                                    </label>
                                                                    <span class="switch-label">Hide Following/Followers counts</span>
                                                                </div>
                                                            </div>
                                        <div class="editprof-footer">
                                            <button class="btn secondary" id="cancelEditProf">Cancel</button>
                                            <button class="btn primary" id="saveEditProf">Save Changes</button>
                                        </div>
                                    </div>`;
                document.body.appendChild(overlay);
                const close = () => overlay.remove();
                overlay.querySelector('.editprof-close').addEventListener('click', close);
                overlay.querySelector('#cancelEditProf').addEventListener('click', close);
                // preset from current state
                const fullnameElLive = document.querySelector('.profile-fullname');
                const statsElLive = document.querySelector('.profile-stats');
                const hideNow = !!(fullnameElLive && fullnameElLive.classList.contains('is-hidden'));
                const hideStatsNow = !!(statsElLive && statsElLive.classList.contains('is-hidden'));
                overlay.querySelector('#hideFullnameToggle').checked = hideNow;
                overlay.querySelector('#hideFollowStatsToggle').checked = hideStatsNow;
                overlay.querySelector('#saveEditProf').addEventListener('click', async () => {
                    const hide_fullname = overlay.querySelector('#hideFullnameToggle').checked;
                    const hide_follow_stats = overlay.querySelector('#hideFollowStatsToggle').checked;
                    // Optimistic UI update of fullname visibility
                    const fullnameEl = document.querySelector('.profile-fullname');
                    if (fullnameEl) { fullnameEl.classList.toggle('is-hidden', !!hide_fullname); }
                    const statsEl = document.querySelector('.profile-stats');
                    if (statsEl) { statsEl.classList.toggle('is-hidden', !!hide_follow_stats); }
                    try {
                        const res = await fetch('/profile/update-settings/', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                            body: JSON.stringify({ hide_fullname, hide_follow_stats })
                        });
                        const data = await res.json();
                        if (!data.success) throw new Error(data.error || 'Failed to save');
                        close();
                    } catch (e) {
                        alert(e.message || 'Failed to save settings');
                        // revert if failed
                        if (fullnameEl) { fullnameEl.classList.toggle('is-hidden', !!hideNow); }
                        if (statsEl) { statsEl.classList.toggle('is-hidden', !!hideStatsNow); }
                    }
                });
            });
        })();
        const avatarImg = document.getElementById('profileAvatarImg');


        function openAvatarModal() {
            // Build lightweight modal
            const overlay = document.createElement('div');
            overlay.className = 'avatar-modal-overlay';
            overlay.innerHTML = `
                <div class="avatar-modal">
                    <div class="avatar-modal-header">
                        <h3>Update Avatar</h3>
                        <button class="avatar-close" aria-label="Close">√ó</button>
                    </div>
                    <div class="avatar-modal-body">
                        <div class="avatar-cropper">
                            <div class="crop-stage">
                                <img class="crop-image" alt="avatar to crop" />
                                <div class="crop-mask"></div>
                            </div>
                        </div>
                        <div class="avatar-controls">
                            <input type="file" id="avatarFile" accept="image/*" hidden />
                            <button class="btn small" id="chooseAvatar">Choose Image</button>
                            <div class="spacer"></div>
                            <label>Zoom</label>
                            <input type="range" id="avatarZoom" min="0.5" max="3" step="0.01" value="1" />
                        </div>
                    </div>
                    <div class="avatar-modal-footer">
                        <button class="btn secondary" id="cancelAvatar">Cancel</button>
                        <button class="btn primary" id="saveAvatar">Save</button>
                    </div>
                </div>`;
            document.body.appendChild(overlay);

            const fileInput = overlay.querySelector('#avatarFile');
            const chooseBtn = overlay.querySelector('#chooseAvatar');
            const closeBtn = overlay.querySelector('.avatar-close');
            const cancelBtn = overlay.querySelector('#cancelAvatar');
            const saveBtn = overlay.querySelector('#saveAvatar');
            const cropImg = overlay.querySelector('.crop-image');
            const zoomInput = overlay.querySelector('#avatarZoom');
            const stage = overlay.querySelector('.crop-stage');

            let img = new Image();
            let scale = 1;
            let pos = { x: 0, y: 0 };
            let dragging = false;
            let last = { x: 0, y: 0 };

            function loadSource(file) {
                const reader = new FileReader();
                reader.onload = () => {
                    cropImg.src = reader.result;
                    img = new Image();
                    img.onload = () => {
                        // center image
                        scale = Math.max(1, Math.min(2, 240 / Math.min(img.width, img.height)));
                        zoomInput.value = scale.toFixed(2);
                        pos = { x: 0, y: 0 };
                        updateTransform();
                    };
                    img.src = reader.result;
                };
                reader.readAsDataURL(file);
            }

            function updateTransform() {
                // Order: center -> scale -> translate (so pos is not scaled)
                cropImg.style.transform = `translate(-50%, -50%) scale(${scale}) translate(${pos.x}px, ${pos.y}px)`;
            }

            function onMouseDown(e) { dragging = true; last = { x: e.clientX, y: e.clientY }; }
            function onMouseMove(e) {
                if (!dragging) return;
                const dx = e.clientX - last.x; const dy = e.clientY - last.y;
                pos.x += dx; pos.y += dy; last = { x: e.clientX, y: e.clientY }; updateTransform();
            }
            function onMouseUp() { dragging = false; }

            stage.addEventListener('mousedown', onMouseDown);
            window.addEventListener('mousemove', onMouseMove);
            window.addEventListener('mouseup', onMouseUp);
            stage.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = -e.deltaY; // up zooms in
                const factor = delta > 0 ? 1.05 : 0.95;
                scale = Math.min(3, Math.max(0.5, scale * factor));
                zoomInput.value = scale.toFixed(2);
                updateTransform();
            }, { passive: false });

            zoomInput.addEventListener('input', () => { scale = parseFloat(zoomInput.value); updateTransform(); });
            chooseBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', () => {
                if (fileInput.files && fileInput.files[0]) {
                    loadSource(fileInput.files[0]);
                }
            });

            // preset with current avatar without fetching
            (function presetFromCurrent() {
                try {
                    cropImg.src = avatarImg.src;
                    img = new Image();
                    img.onload = () => { scale = 1; pos = { x: 0, y: 0 }; updateTransform(); };
                    img.src = avatarImg.src;
                } catch (e) { }
            })();

            function destroy() {
                window.removeEventListener('mousemove', onMouseMove);
                window.removeEventListener('mouseup', onMouseUp);
                overlay.remove();
            }
            closeBtn.addEventListener('click', destroy);
            cancelBtn.addEventListener('click', destroy);

            saveBtn.addEventListener('click', async () => {
                // Render a square crop (256x256)
                const canvas = document.createElement('canvas');
                const size = 256; canvas.width = size; canvas.height = size;
                const ctx = canvas.getContext('2d');

                // Compute source rect from logical state
                const S = stage.clientWidth; // stage square size in CSS px
                const W = img.width; const H = img.height; // image pixels
                const s = scale; const tx = pos.x; const ty = pos.y; // px translations

                // Source width/height in image pixels that fills the stage viewport
                const sw = S / s; const sh = sw;
                // Top-left source coords such that the stage center maps to image center shifted by pos
                let sx = W / 2 - (S / 2 + tx) / s;
                let sy = H / 2 - (S / 2 + ty) / s;
                // Clamp to image bounds
                sx = Math.max(0, Math.min(W - sw, sx));
                sy = Math.max(0, Math.min(H - sh, sy));

                ctx.fillStyle = '#222';
                ctx.fillRect(0, 0, size, size);
                try { ctx.drawImage(img, sx, sy, sw, sh, 0, 0, size, size); } catch (e) { }

                const dataUrl = canvas.toDataURL('image/jpeg', 0.92);
                saveBtn.disabled = true;
                try {
                    const res = await fetch('/profile/update-avatar/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                        body: JSON.stringify({ image_data: dataUrl })
                    });
                    const data = await res.json();
                    if (!data.success) throw new Error(data.error || 'Failed to update avatar');
                    // Update avatar on page and navbar
                    const newSrc = 'data:image/jpeg;base64,' + data.pfp;
                    avatarImg.src = newSrc;
                    const navImg = document.querySelector('img.rounded-circle.me-2');
                    if (navImg) navImg.src = newSrc;
                    destroy();
                } catch (err) {
                    alert(err.message || 'Failed to update avatar');
                } finally {
                    saveBtn.disabled = false;
                }
            });
        }

        const avatarContainer = document.querySelector('.profile-avatar.editable');
        if (avatarContainer) {
            avatarContainer.addEventListener('click', (e) => { e.preventDefault(); openAvatarModal(); });
            avatarContainer.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openAvatarModal(); }
            });
        }
    }
</script>

<style>
    .profile-avatar.editable {
        position: relative;
        cursor: pointer;
    }

    .profile-avatar.editable img {
        cursor: pointer;
        transition: filter 0.2s ease;
    }

    .profile-avatar.editable:hover img {
        filter: grayscale(20%) brightness(0.85);
    }

    .avatar-hover-indicator {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #eee;
        background: rgba(0, 0, 0, 0.0);
        opacity: 0;
        transition: background 0.2s ease, opacity 0.2s ease;
        pointer-events: none;
    }

    .profile-avatar.editable:hover .avatar-hover-indicator {
        background: rgba(0, 0, 0, 0.35);
        opacity: 1;
    }

    .avatar-modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .avatar-modal {
        background: #161616;
        border: 1px solid #2a2a2a;
        border-radius: 8px;
        width: min(92vw, 720px);
        max-width: 720px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
    }

    .avatar-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.9rem 1rem;
        border-bottom: 1px solid #2a2a2a;
        color: #ddd;
    }

    .avatar-close {
        background: transparent;
        border: none;
        color: #aaa;
        font-size: 1.4rem;
        cursor: pointer;
    }

    .avatar-close:hover {
        color: #fff;
    }

    .avatar-modal-body {
        padding: 1rem;
    }

    .avatar-cropper {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .crop-stage {
        position: relative;
        width: 100%;
        max-width: 520px;
        aspect-ratio: 1 / 1;
        margin: 0 auto;
        background: #111;
        border: 1px dashed #333;
        overflow: hidden;
        border-radius: 8px;
    }

    .crop-image {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(1);
        transform-origin: center center;
        user-select: none;
        pointer-events: none;
    }

    .crop-mask {
        position: absolute;
        inset: 0;
        pointer-events: none;
    }

    .crop-mask::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 100%;
        height: 100%;
        transform: translate(-50%, -50%);
        border-radius: 50%;
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.45);
    }

    .crop-mask::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: calc(100% - 3px);
        height: calc(100% - 3px);
        transform: translate(-50%, -50%);
        border-radius: 50%;
        border: 1.5px solid rgba(255, 255, 255, 0.25);
    }

    .avatar-controls {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0 0.25rem;
        color: #aaa;
    }

    .avatar-controls .spacer {
        flex: 1;
    }

    .avatar-controls .btn {
        background: #222;
        border: 1px solid #333;
        color: #eee;
    }

    .avatar-controls .btn:hover {
        background: #2a2a2a;
    }

    .avatar-controls label {
        color: #ddd;
    }

    .avatar-modal-footer {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 0.75rem;
        padding: 0.9rem 1rem;
        border-top: 1px solid #2a2a2a;
    }

    .btn.small {
        padding: 0.4rem 0.7rem;
        font-size: 0.9rem;
    }

    .btn.primary {
        background: #6d28d9;
        border: 1px solid #7c3aed;
        color: #fff;
    }

    .btn.primary:hover {
        background: #7c3aed;
    }

    .btn.secondary {
        background: #222;
        border: 1px solid #333;
        color: #ddd;
    }

    .btn.secondary:hover {
        background: #2a2a2a;
    }

    input[type="range"] {
        accent-color: #7c3aed;
    }

    .profile-fullname.is-hidden {
        display: none;
    }

    .profile-stats.is-hidden {
        display: none;
    }

    .editprof-body .switch-row {
        display: flex;
        align-items: center;
        gap: 0.6rem;
    }

    /* Edit Profile modal */
    .editprof-modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .editprof-modal {
        background: #161616;
        border: 1px solid #2a2a2a;
        border-radius: 8px;
        width: min(92vw, 560px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
    }

    .editprof-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.9rem 1rem;
        border-bottom: 1px solid #2a2a2a;
        color: #ddd;
    }

    .editprof-close {
        background: transparent;
        border: none;
        color: #aaa;
        font-size: 1.4rem;
        cursor: pointer;
    }

    .editprof-close:hover {
        color: #fff;
    }

    .editprof-body {
        padding: 1rem;
        display: flex;
        align-items: center;
        gap: 0.6rem;
        color: #ddd;
    }

    .editprof-footer {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 0.75rem;
        padding: 0.9rem 1rem;
        border-top: 1px solid #2a2a2a;
    }

    /* Toggle switch */
    .switch {
        position: relative;
        display: inline-block;
        width: 46px;
        height: 24px;
    }

    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #333;
        transition: .2s;
        border-radius: 24px;
        border: 1px solid #444;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .2s;
        border-radius: 50%;
    }

    .switch input:checked+.slider {
        background-color: #6d28d9;
        border-color: #7c3aed;
    }

    .switch input:checked+.slider:before {
        transform: translateX(22px);
    }

    .switch-label {
        user-select: none;
    }

    /* Profile Hero */
    .profile-hero {
        position: relative;
        height: 46vh;
        min-height: 320px;
        max-height: 520px;
        background-size: cover;
        background-position: center;
        border-radius: 14px;
        overflow: hidden;
    }

    .profile-hero::after {
        content: "";
        position: absolute;
        inset: 0;
        background:
            linear-gradient(to bottom, rgba(10, 10, 10, 0.0) 0%, rgba(10, 10, 10, 0.25) 55%, rgba(10, 10, 10, 0.85) 100%),
            linear-gradient(to right, rgba(10, 10, 10, 0.65) 0%, rgba(10, 10, 10, 0.0) 20%, rgba(10, 10, 10, 0.0) 80%, rgba(10, 10, 10, 0.65) 100%);
        pointer-events: none;
    }

    .profile-hero-overlay {
        position: absolute;
        inset: 0;
        background: linear-gradient(180deg, rgba(0, 0, 0, 0.0) 0%, rgba(0, 0, 0, 0.1) 40%, rgba(0, 0, 0, 0.6) 100%);
    }

    .profile-hero-inner {
        position: relative;
        z-index: 1;
        height: 100%;
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        gap: 1.2rem;
        padding: 1.25rem 1.25rem 1.5rem;
    }

    .profile-hero-left {
        display: flex;
        align-items: flex-end;
        gap: 1.2rem;
    }

    .profile-hero .profile-avatar {
        width: 140px;
        height: 140px;
        margin-top: 0;
        border: 4px solid rgba(0, 0, 0, 0.35);
        box-shadow: 0 8px 28px rgba(0, 0, 0, 0.6);
    }

    .profile-hero .profile-details {
        margin-bottom: 10px;
    }

    .profile-hero .profile-username {
        font-size: 2rem;
        margin: 0;
    }

    .profile-hero .profile-fullname {
        margin: 0.25rem 0 0.75rem;
    }

    /* Right-side stats */
    .profile-hero-right {
        display: flex;
        align-items: flex-end;
    }

    .profile-stats {
        display: flex;
        align-items: stretch;
        gap: 1.1rem;
        background: rgba(0, 0, 0, 0.35);
        border: 1px solid rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(6px);
        padding: 0.6rem 0.9rem;
        border-radius: 12px;
    }

    .profile-stats .stat {
        min-width: 90px;
        text-align: center;
        color: #eaeaea;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .profile-stats .stat-number {
        font-size: 1.6rem;
        font-weight: 800;
        line-height: 1.1;
        letter-spacing: -0.3px;
    }

    .profile-stats .stat-label {
        font-size: 0.8rem;
        color: #c8c8c8;
        margin-top: 2px;
    }

    .profile-stats .divider {
        width: 1px;
        background: rgba(255, 255, 255, 0.18);
        margin: 0 0.1rem;
    }

    @media (max-width: 800px) {
        .profile-hero-inner {
            align-items: flex-end;
            gap: 0.9rem;
        }

        .profile-hero .profile-avatar {
            width: 110px;
            height: 110px;
        }

        .profile-hero .profile-username {
            font-size: 1.6rem;
        }

        .profile-stats {
            display: none;
        }
    }

    /* Sections */
    .section-block {
        margin-bottom: 1.5rem;
    }

    .section-header h3 {
        margin: 0 0 0.75rem;
        color: #fff;
        font-size: 1.15rem;
    }

    .muted {
        color: #9aa0a6;
    }

    /* Favorites */
    .favorites-row {
        display: grid;
        grid-template-columns: repeat(5, minmax(0, 1fr));
        gap: 0.8rem;
    }

    .fav-card {
        display: block;
        text-decoration: none;
        color: inherit;
    }

    .fav-poster {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        background: #222;
        aspect-ratio: 2/3;
    }

    .fav-poster img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    .fav-placeholder {
        width: 100%;
        height: 100%;
        display: grid;
        place-items: center;
        color: #777;
        font-size: 0.8rem;
    }

    .fav-score {
        position: absolute;
        right: 6px;
        top: 6px;
        background: rgba(0, 0, 0, 0.7);
        color: #ffd166;
        font-weight: 700;
        padding: 2px 6px;
        border-radius: 999px;
        font-size: 0.8rem;
    }

    .fav-title {
        margin-top: 0.4rem;
        font-size: 0.9rem;
        color: #ddd;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Activity */
    .activity-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .activity-item {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        text-decoration: none;
        color: inherit;
        background: #151515;
        border: 1px solid #242424;
        border-radius: 10px;
        padding: 0.6rem;
    }

    .recent-poster {
        width: 56px;
        aspect-ratio: 2/3;
        border-radius: 6px;
        overflow: hidden;
        background: #222;
        flex: 0 0 auto;
    }

    .recent-poster img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .recent-meta {
        min-width: 0;
    }

    .recent-title {
        color: #fff;
        font-weight: 600;
    }

    .recent-sub {
        color: #9aa0a6;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    .recent-chip {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 999px;
        background: #222;
        border: 1px solid #333;
        font-size: 0.75rem;
    }

    .recent-chip.watched {
        color: #4ade80;
        border-color: #245f3a;
    }

    .recent-chip.listed {
        color: #60a5fa;
        border-color: #1e3a8a;
    }

    .meta-dot {
        color: #666;
    }

    /* Reviews */
    .reviews-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .reviews-list.all {
        gap: 0.9rem;
    }

    .review-item {
        display: flex;
        gap: 0.75rem;
        text-decoration: none;
        color: inherit;
        background: #151515;
        border: 1px solid #242424;
        border-radius: 10px;
        padding: 0.7rem;
        align-items: stretch;
    }

    .ri-poster {
        width: 64px;
        aspect-ratio: 2/3;
        border-radius: 6px;
        overflow: hidden;
        background: #222;
        flex: 0 0 auto;
    }

    .ri-poster img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .ri-body {
        min-width: 0;
        display: flex;
        flex-direction: column;
    }

    .ri-title {
        color: #fff;
        font-weight: 700;
    }

    .ri-sub {
        color: #9aa0a6;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.4rem;
        margin: 0.15rem 0 0.35rem;
    }

    .ri-score {
        color: #ffd166;
    }

    .ri-date {
        color: #9aa0a6;
    }

    .ri-text {
        color: #c8c8c8;
        display: -webkit-box;
        -webkit-line-clamp: 4;
        line-clamp: 4;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* Lists grid */
    .lists-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 1rem;
    }

    .list-card {
        display: block;
        text-decoration: none;
        color: inherit;
        background: #151515;
        border: 1px solid #242424;
        border-radius: 10px;
        overflow: hidden;
    }

    .list-collage {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 2px;
        aspect-ratio: 5/2;
        background: #222;
    }

    .list-tile {
        background-size: cover;
        background-position: center;
        border-radius: 2px;
    }

    .list-empty {
        display: grid;
        place-items: center;
        color: #777;
        font-size: 0.85rem;
    }

    .list-meta {
        padding: 0.6rem 0.75rem 0.8rem;
    }

    .list-title {
        color: #fff;
        font-weight: 700;
        margin-bottom: 0.2rem;
    }

    .list-sub {
        color: #9aa0a6;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    .list-sub .stat {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
    }

    .pill {
        display: inline-block;
        border: 1px solid #333;
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 0.75rem;
        color: #c8c8c8;
    }

    .pill.public {
        color: #4ade80;
        border-color: #245f3a;
    }

    @media (max-width: 900px) {
        .favorites-row {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }

        .lists-grid {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
    }

    .profile-hero-content {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: flex-end;
        gap: 1rem;
        padding: 1.25rem 1.5rem;
    }

    .profile-hero-content .profile-avatar {
        width: 120px;
        height: 120px;
        margin-top: 0;
        border: 4px solid rgba(0, 0, 0, 0.35);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
    }

    .profile-hero-content .profile-details {
        margin: 0 0 6px 0;
    }

    .profile-hero-content .profile-username {
        font-size: 1.8rem;
    }

    .profile-hero-content .profile-fullname {
        margin: 0.2rem 0 0.6rem;
    }

    .profile-banner-overlay {
        position: absolute;
        inset: 0;
        background: linear-gradient(to bottom, rgba(0, 0, 0, 0.0) 0%, rgba(0, 0, 0, 0.45) 70%, rgba(0, 0, 0, 0.75) 100%),
            linear-gradient(to right, rgba(10, 10, 10, 0.65) 0%, rgba(10, 10, 10, 0.25) 20%, rgba(10, 10, 10, 0.25) 80%, rgba(10, 10, 10, 0.65) 100%);
        pointer-events: none;
    }

    @media (max-width: 600px) {
        .favorites-row {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .lists-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% load static %}

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Brand Font (cool, professional, futuristic) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Orbitron:wght@600;700&display=swap" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="{% static 'styles.css' %}" rel="stylesheet">

    <title>{% block title %}Recensio - Discover Shows & Movies {% endblock %}</title>
</head>

<body class="{% block body_class %}{% endblock %}">
    {% include 'navbar.html' %}

    <main class="{% block main_class %}container{% endblock %}">
        {% block content %}
        <p>This is the default content.</p>
        {% endblock %}
    </main>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Global Modals (for Add to List and Rating), available on all pages -->
    <div class="modal fade" id="globalRatingModal" tabindex="-1" aria-labelledby="globalRatingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="globalRatingModalLabel">Rate</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="rating-slider-container">
                        <label for="globalScoreSlider" class="form-label">Your Score: <span id="globalScoreValue">50</span></label>
                        <input type="range" class="form-range" id="globalScoreSlider" min="0" max="100" value="50">
                    </div>
                    <div class="mt-3">
                        <label for="globalReviewText" class="form-label">Review (Optional)</label>
                        <textarea class="form-control" id="globalReviewText" rows="4" placeholder="Write your review here..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="globalSubmitRating">Submit Rating</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="globalListModal" tabindex="-1" aria-labelledby="globalListModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="globalListModalLabel">Add to List</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="btn-group w-100 mb-3" role="group">
                        <button type="button" class="btn btn-outline-secondary active" id="globalTabPublic">Public</button>
                        <button type="button" class="btn btn-outline-secondary" id="globalTabPrivate">Private</button>
                    </div>

                    <div id="globalListContainer">
                        <div class="mb-2 small text-muted">Your lists:</div>
                        <div id="globalListsArea" class="list-group small"></div>
                    </div>

                    <hr class="my-3">
                    <div>
                        <div class="mb-2 small text-muted">Create new list</div>
                        <div class="mb-2">
                            <input type="text" class="form-control" id="globalNewListName" placeholder="List name">
                        </div>
                        <div class="mb-2">
                            <textarea class="form-control" id="globalNewListDesc" rows="2" placeholder="Description (optional)"></textarea>
                        </div>
                        <div class="d-grid mt-2">
                            <button class="btn btn-primary" id="globalCreateListBtn">Create List</button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="globalConfirmAddToList" disabled>Add</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global handlers for content action buttons across site
        document.addEventListener('DOMContentLoaded', function () {
            let activeItem = null; // { tmdb_id, media_type, title, poster_path }

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            // Delegated click handling for .content-action-btn
            let lastReviewBtn = null;
            document.body.addEventListener('click', async (e) => {
                const btn = e.target.closest('.content-action-btn');
                if (!btn) return;
                // Prevent underlying <a> link navigation
                e.preventDefault();
                e.stopPropagation();
                const card = btn.closest('.content-card');
                if (!card) return;
                const action = btn.dataset.action;
                activeItem = {
                    tmdb_id: card.dataset.tmdbId,
                    media_type: card.dataset.mediaType,
                    title: card.dataset.title,
                    poster_path: card.dataset.posterPath
                };

                if (action === 'watch') {
                    btn.disabled = true;
                    try {
                        const res = await fetch('/mark-watched/', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                            body: JSON.stringify(activeItem)
                        });
                        const data = await res.json();
                        if (data.success) {
                            btn.classList.add('active');
                            btn.title = 'Watched';
                        } else {
                            alert(data.error || 'Failed to mark as watched');
                            btn.disabled = false;
                        }
                    } catch (err) {
                        alert('Failed to mark as watched');
                        btn.disabled = false;
                    }
                }

                if (action === 'list') {
                    openGlobalListModal();
                }

                if (action === 'review') {
                    lastReviewBtn = btn;
                    openGlobalRatingModal();
                }
            });

            // Prevent link navigation when clicking empty card areas (only poster should navigate)
            document.body.addEventListener('click', (e) => {
                const link = e.target.closest('.content-card-link');
                if (!link) return;
                // Allow if clicking poster/placeholder or overlay controls (their own handlers stop nav)
                const overPoster = e.target.closest('.content-poster, .content-poster-placeholder');
                const overActions = e.target.closest('.content-actions, .content-action-btn');
                if (!overPoster && !overActions) {
                    e.preventDefault();
                }
            });

            // Global Rating Modal logic
            const ratingModalEl = document.getElementById('globalRatingModal');
            const ratingModal = new bootstrap.Modal(ratingModalEl);
            const scoreSlider = document.getElementById('globalScoreSlider');
            const scoreValue = document.getElementById('globalScoreValue');
            const reviewText = document.getElementById('globalReviewText');
            const submitRating = document.getElementById('globalSubmitRating');

            function updateSliderColor(value) {
                const percentage = value / 100;
                let color;
                if (value < 25) color = `hsl(0, 100%, ${40 + percentage * 20}%)`;
                else if (value < 50) color = `hsl(${(value - 25) * 1.2}, 100%, 50%)`;
                else if (value < 75) color = `hsl(${30 + (value - 50) * 1.2}, 100%, 50%)`;
                else color = `hsl(${60 + (value - 75) * 1.2}, 70%, 50%)`;
                scoreSlider?.style.setProperty('--slider-color', color);
                if (scoreValue) { scoreValue.textContent = value; scoreValue.style.color = color; }
            }
            scoreSlider?.addEventListener('input', (e) => updateSliderColor(e.target.value));
            updateSliderColor(50);

            function openGlobalRatingModal() {
                if (!activeItem) return;
                reviewText.value = '';
                scoreSlider.value = 50;
                updateSliderColor(50);
                const label = document.getElementById('globalRatingModalLabel');
                if (label) label.textContent = `Rate ${activeItem.title}`;
                ratingModal.show();
            }

            submitRating?.addEventListener('click', async () => {
                if (!activeItem) return;
                submitRating.disabled = true;
                try {
                    const res = await fetch('/add-rating/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                        body: JSON.stringify({ ...activeItem, score: scoreSlider.value, review_text: reviewText.value })
                    });
                    const data = await res.json();
                    if (data.success) {
                        ratingModal.hide();
                        alert('Rating submitted');
                        if (lastReviewBtn) {
                            lastReviewBtn.classList.add('active', 'review-active');
                        }
                    } else {
                        alert(data.error || 'Failed to submit rating');
                    }
                } catch (e) {
                    alert('Failed to submit rating');
                } finally {
                    submitRating.disabled = false;
                }
            });

            // Global Add-to-List modal
            const listModalEl = document.getElementById('globalListModal');
            const listModal = new bootstrap.Modal(listModalEl);
            const tabPublic = document.getElementById('globalTabPublic');
            const tabPrivate = document.getElementById('globalTabPrivate');
            const listsArea = document.getElementById('globalListsArea');
            const confirmAddBtn = document.getElementById('globalConfirmAddToList');
            const newListName = document.getElementById('globalNewListName');
            const newListDesc = document.getElementById('globalNewListDesc');
            const createListBtn = document.getElementById('globalCreateListBtn');
            let listVisibility = true;
            let selectedListId = null;

            function renderLists(lists) {
                listsArea.innerHTML = '';
                if (!lists || lists.length === 0) {
                    listsArea.innerHTML = '<div class="text-muted">No lists yet.</div>';
                    return;
                }
                lists.forEach(lst => {
                    const a = document.createElement('a');
                    a.href = '#';
                    a.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                    a.textContent = lst.name;
                    a.dataset.listId = lst.id;
                    a.addEventListener('click', (e) => {
                        e.preventDefault();
                        selectedListId = lst.id;
                        confirmAddBtn.disabled = false;
                        listsArea.querySelectorAll('.list-group-item').forEach(el => el.classList.remove('active'));
                        a.classList.add('active');
                    });
                    listsArea.appendChild(a);
                });
            }

            async function loadLists() {
                listsArea.innerHTML = '<div class="text-muted">Loadingâ€¦</div>';
                try {
                    const res = await fetch('/lists/fetch/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                        body: JSON.stringify({ is_public: listVisibility })
                    });
                    const data = await res.json();
                    if (data.success) renderLists(data.lists);
                    else listsArea.innerHTML = `<div class="text-danger">${data.error || 'Failed to load lists'}</div>`;
                } catch (e) {
                    listsArea.innerHTML = '<div class="text-danger">Failed to load lists</div>';
                }
            }

            function openGlobalListModal() {
                if (!activeItem) return;
                selectedListId = null;
                confirmAddBtn.disabled = true;
                tabPublic.classList.add('active');
                tabPrivate.classList.remove('active');
                listVisibility = true;
                listModal.show();
                loadLists();
            }

            tabPublic?.addEventListener('click', () => {
                listVisibility = true;
                tabPublic.classList.add('active');
                tabPrivate.classList.remove('active');
                selectedListId = null;
                confirmAddBtn.disabled = true;
                loadLists();
            });
            tabPrivate?.addEventListener('click', () => {
                listVisibility = false;
                tabPrivate.classList.add('active');
                tabPublic.classList.remove('active');
                selectedListId = null;
                confirmAddBtn.disabled = true;
                loadLists();
            });

            createListBtn?.addEventListener('click', async () => {
                const name = newListName.value.trim();
                const description = newListDesc.value.trim();
                const is_public = tabPublic?.classList.contains('active');
                if (!name) { alert('Please enter a list name'); return; }
                try {
                    const res = await fetch('/lists/create/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                        body: JSON.stringify({ name, description, is_public })
                    });
                    const data = await res.json();
                    if (data.success) {
                        if (data.list.is_public === listVisibility) await loadLists();
                        newListName.value = '';
                        newListDesc.value = '';
                    } else {
                        alert(data.error || 'Failed to create list');
                    }
                } catch (e) {
                    alert('Failed to create list');
                }
            });

            confirmAddBtn?.addEventListener('click', async () => {
                if (!selectedListId || !activeItem) return;
                confirmAddBtn.disabled = true;
                try {
                    const res = await fetch('/lists/add-item/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                        body: JSON.stringify({ list_id: selectedListId, ...activeItem })
                    });
                    const data = await res.json();
                    if (data.success) { listModal.hide(); alert('Added to list'); }
                    else { alert(data.error || 'Failed to add to list'); }
                } catch (e) {
                    alert('Failed to add to list');
                } finally {
                    confirmAddBtn.disabled = false;
                }
            });
        });
    </script>
    {% block extra_js %}{% endblock %}
</body>

</html>
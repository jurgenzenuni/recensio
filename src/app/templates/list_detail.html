{% extends 'base.html' %}

{% block body_class %}list-page{% endblock %}

{% block content %}
<div class="list-container">
  <div class="list-header">
    <h1 class="list-title">{{ list.name }}</h1>
    <div class="list-meta">
      {% if owner.pfp %}
        <img class="owner-avatar" src="data:image/jpeg;base64,{{ owner.pfp }}" alt="{{ owner.username }}">
      {% else %}
        <img class="owner-avatar" src="/static/images/pfp-basic.jpg" alt="{{ owner.username }}">
      {% endif %}
      <a class="owner" href="/{{ owner.username }}">@{{ owner.username }}</a>
      <span class="dot">•</span>
      <span class="privacy">{% if list.is_public %}Public{% else %}Private{% endif %}</span>
  {% if is_logged_in and total_items > 0 %}
      <span class="dot">•</span>
      <span class="watched-progress" title="{{ watched_count }} of {{ total_items }} items watched by you">
        <span class="watched-label">You've Watched</span>
        <span class="progress-circle" style="--p: {{ watched_percentage }}%">
          <span class="inner"><span class="value">{{ watched_percentage }}%</span></span>
        </span>
      </span>
  {% endif %}
    </div>

    <div class="list-actions">
      <button class="like-btn {% if liked_by_me %}liked{% endif %}" id="likeBtn" data-list-id="{{ list.id }}" {% if not is_logged_in %}disabled title="Please log in"{% endif %}>
        <svg class="heart" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
        <span id="likesCount">{{ list.likes_count }}</span>
      </button>
      <span class="dot">•</span>
      <span class="comments-count"><strong id="commentsCount">{{ list.comments_count }}</strong> Comments</span>
    </div>

    {% if list.description %}
      <p class="list-desc">{{ list.description }}</p>
    {% endif %}
  </div>

  <div class="content-grid">
    {% for item in items %}
      <a href="/{{ item.media_type }}/{{ item.title|slugify }}/" class="content-card-link">
        <div class="content-card" data-tmdb-id="{{ item.tmdb_id }}" data-media-type="{{ item.media_type }}" data-title="{{ item.title }}" data-poster-path="{{ item.poster_path|default:'' }}">
          {% if item.poster_path %}
            <img src="https://image.tmdb.org/t/p/w342{{ item.poster_path }}" alt="{{ item.title }}" class="content-poster">
          {% else %}
            <div class="content-poster-placeholder">No Image</div>
          {% endif %}
          {% if is_logged_in %}
          <div class="content-actions">
            <div class="content-actions-bar">
              <button class="content-action-btn{% if item.watched_by_me %} active watched-active{% endif %}" data-action="watch" title="Mark as watched" aria-label="Watched">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
              </button>
              <button class="content-action-btn" data-action="list" title="Add to list" aria-label="Add to list">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
              </button>
              <button class="content-action-btn{% if item.reviewed_by_me %} active review-active{% endif %}" data-action="review" title="Review" aria-label="Review">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
              </button>
            </div>
          </div>
          {% endif %}
        </div>
      </a>
    {% empty %}
      <p class="no-items">No items yet.</p>
    {% endfor %}
  </div>

  <div class="comments-section">
    <h2 class="section-title">Comments</h2>

    <div class="comment-form" style="margin-bottom: 12px;">
      <textarea class="form-control" id="commentText" rows="3" placeholder="Write a comment..." {% if not is_logged_in %}disabled{% endif %}></textarea>
      <div class="mt-2">
        <button class="btn btn-primary" id="submitComment" {% if not is_logged_in %}disabled title="Please log in"{% endif %}>Post Comment</button>
      </div>
    </div>

    <div class="comments-list" id="commentsList">
      {% for c in comments %}
        <div class="comment" data-comment-id="{{ c.id }}">
          <div class="comment-header">
            {% if c.pfp %}
              <img src="data:image/jpeg;base64,{{ c.pfp }}" class="comment-avatar" alt="{{ c.username }}">
            {% else %}
              <img src="/static/images/pfp-basic.jpg" class="comment-avatar" alt="{{ c.username }}">
            {% endif %}
            <div class="comment-meta">
              <a href="/{{ c.username }}" class="comment-user">{{ c.username }}</a>
              <span class="comment-date">{{ c.created_at|date:"M d, Y h:ia" }}</span>
            </div>
            {# Django templates don't support parentheses in conditions. Duplicate is_logged_in to preserve logic. #}
            {% if is_logged_in and is_list_owner or is_logged_in and current_user_id == c.user_id %}
              <button class="comment-delete-btn" title="Delete comment" data-comment-id="{{ c.id }}" aria-label="Delete comment" style="margin-left:auto">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path></svg>
              </button>
            {% endif %}
          </div>
          <div class="comment-text">{{ c.comment_text }}</div>
        </div>
      {% empty %}
        <p class="no-comments">No comments yet.</p>
      {% endfor %}
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const likeBtn = document.getElementById('likeBtn');
    const likesCount = document.getElementById('likesCount');
    const commentsCount = document.getElementById('commentsCount');
    const submitComment = document.getElementById('submitComment');
    const commentText = document.getElementById('commentText');

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    likeBtn?.addEventListener('click', async function() {
      try {
        const res = await fetch('/lists/toggle-like/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
          body: JSON.stringify({ list_id: this.dataset.listId })
        });
        const data = await res.json();
        if (data.success) {
          likesCount.textContent = data.likes_count;
          this.classList.toggle('liked', data.liked);
        } else {
          alert(data.error || 'Failed to like');
        }
      } catch (e) {
        alert('Failed to like');
      }
    });

    submitComment?.addEventListener('click', async function() {
      const text = commentText.value.trim();
      if (!text) return;
      this.disabled = true;
      try {
        const res = await fetch('/lists/add-comment/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
          body: JSON.stringify({ list_id: likeBtn?.dataset.listId, comment_text: text })
        });
        const data = await res.json();
        if (data.success) {
          // optimistic append
          const c = data.comment;
          const wrapper = document.getElementById('commentsList');
          const div = document.createElement('div');
            div.className = 'comment';
            div.dataset.commentId = c.id;
          div.innerHTML = `
            <div class="comment-header">
              <img src="/static/images/pfp-basic.jpg" class="comment-avatar" alt="me">
              <div class="comment-meta">
                <span class="comment-user">You</span>
                <span class="comment-date">just now</span>
              </div>
                <button class="comment-delete-btn" title="Delete comment" data-comment-id="${c.id}" aria-label="Delete comment" style="margin-left:auto">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path></svg>
                </button>
            </div>
            <div class="comment-text"></div>`;
          div.querySelector('.comment-text').textContent = c.comment_text;
          wrapper.prepend(div);
          commentsCount.textContent = c.comments_count;
          commentText.value = '';
            // bind delete handler to the new button
            const delBtn = div.querySelector('.comment-delete-btn');
            delBtn?.addEventListener('click', handleDeleteComment);
        } else {
          alert(data.error || 'Failed to comment');
        }
      } catch (e) {
        alert('Failed to comment');
      } finally {
        this.disabled = false;
      }
    });

    async function handleDeleteComment(evt) {
      const btn = evt.currentTarget;
      const cid = btn.dataset.commentId;
      if (!cid) return;
      if (!confirm('Delete this comment?')) return;
      btn.disabled = true;
      try {
        const res = await fetch('/lists/delete-comment/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
          body: JSON.stringify({ comment_id: cid })
        });
        const data = await res.json();
        if (data.success) {
          // remove comment node
          const node = btn.closest('.comment');
          node?.parentNode?.removeChild(node);
          if (commentsCount) commentsCount.textContent = data.comments_count;
        } else {
          alert(data.error || 'Failed to delete comment');
        }
      } catch (e) {
        alert('Failed to delete comment');
      } finally {
        btn.disabled = false;
      }
    }

    // attach handlers to existing delete buttons
    document.querySelectorAll('.comment-delete-btn').forEach(btn => {
      btn.addEventListener('click', handleDeleteComment);
    });
  });
</script>
{% endblock %}
